<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            background: #222;
            min-height: 100vh;
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: #fff;
        }

        #container {
            width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 0;
            box-sizing: border-box;
            color: #fff;
        }

        #top-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 33vh;
            min-height: 200px;
            margin-bottom: 0;
        }

        #main-title {
            margin-bottom: 2em;
            font-size: 2.7em;
            text-align: center;
            color: #fff;
        }

        #cardo-icon {
            width: 260px;
            height: auto;
            margin: 0 auto 1em auto;
            display: block;
        }

        #middle-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 0 auto;
            min-height: 0;
            height: 67vh;
            /* Take up remaining vertical space */
        }

        #status-icon {
            width: 140px;
            height: 140px;
            margin: 0 auto 1em auto;
            display: block;
        }

        #status-icon.mic-disabled {
            filter: grayscale(1) opacity(0.45);
        }

        #status-message {
            min-height: 1.5em;
            text-align: center;
            font-size: 2em;
            color: #fff;
            margin-bottom: 1em;
            /* Always reserve space */
            visibility: hidden;
        }

        @media (max-width: 600px) {
            #container {
                padding: 0;
            }

            #main-title {
                font-size: 1.4em;
            }

            #cardo-icon {
                width: 170px;
                height: auto;
            }

            #status-icon {
                width: 90px;
                height: 90px;
            }

            #top-section {
                min-height: 120px;
            }
        }

        /* Off button styles */
        #off-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 1000;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        #off-btn img {
            width: 48px;
            height: 48px;
        }

        /* Pulse animation for mic icon */
        @keyframes mic-pulse {
            0% {
                transform: scale(3);
                filter: brightness(1);
            }

            50% {
                transform: scale(3.15);
                filter: brightness(1.3);
            }

            100% {
                transform: scale(3);
                filter: brightness(1);
            }
        }

        /* Class to enlarge and pulse the mic icon */
        .mic-enlarged {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(3);
            animation: mic-pulse 1s infinite;
            z-index: 10;
        }

        /* Remove transition for reset */
        .mic-no-transition {
            transition: none !important;
            animation: none !important;
            transform: scale(1) !important;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="top-section">
            <img id="cardo-icon" src="resources/cardo_logo.avif" alt="Cardo Icon">
            <h1 id="main-title">Unlimited ASR Demo</h1>
        </div>
        <div id="middle-section">
            <img id="status-icon" class="mic-disabled" src="resources/mic.png" alt="Status Icon">
            <div id="status-message"></div>
        </div>
    </div>
    <!-- Off button at bottom left -->
    <button id="off-btn" title="Turn Off" style="position:fixed;bottom:24px;left:24px;z-index:1000;background:transparent;border:none;cursor:pointer;padding:0;">
        <img src="resources/power_off.png" alt="Off" style="width:48px;height:48px;">
    </button>
    <audio id="audio-player"></audio>
    <div id="audio-unlock-banner" style="
        display:none;
        position:fixed;
        bottom:24px;
        left:50%;
        transform:translateX(-50%);
        z-index:2002;
        background:#000c;
        color:#fff;
        border:1px solid #fff3;
        border-radius:999px;
        padding:10px 14px;
        font-size:14px;
        line-height:1;
        pointer-events:none;
        ">
        Tap anywhere to enable sound
    </div>
    <div id="log-panel" style="
        position: fixed;
        right: 16px;
        top: 16px;
        width: min(520px, 92vw);
        max-height: 46vh;
        overflow: auto;
        background: #111c;
        color: #cfe;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.35;
        padding: 10px 12px;
        border: 1px solid #2a3;
        border-radius: 8px;
        z-index: 2001;
        ">
        <div style="font-weight:700;color:#9f9;margin-bottom:6px;">Logs</div>
        <div id="log-lines"></div>
    </div>
    <div id="error-message" style="
        color: #fff;
        background: #c00;
        font-size: 1.5em;
        font-weight: bold;
        margin: 0;
        padding: 2em 2em;
        border-radius: 16px;
        box-shadow: 0 4px 24px #000a;
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        text-align: center;
        max-width: 90vw;
        ">
    </div>
    <script src="src/utils.js"></script>
    <script src="src/prompt.js"></script>
    <script src="src/openai.js"></script>
    <script src="src/main.js"></script>
    <script>
        // --- DOM Elements ---
        const mainTitle = document.getElementById('main-title');
        const cardoIcon = document.getElementById('cardo-icon');
        const statusIcon = document.getElementById('status-icon');
        const statusMessage = document.getElementById('status-message');
        const audioPlayer = document.getElementById('audio-player');
        const audioUnlockBanner = document.getElementById('audio-unlock-banner');
        const errorMessage = document.getElementById('error-message');
        const params = new URLSearchParams(window.location.search);
        const logPanel = document.getElementById('log-panel');
        const logLines = document.getElementById('log-lines');
        const logBuffer = [];
        const LOG_MAX = 200;
        let audioUnlockInFlight = null;
        let audioUnlocked = false;

        if (logPanel && !params.has('log')) {
            logPanel.style.display = 'none';
        }

        function logEvent(message, data) {
            const ts = new Date().toISOString().split('T')[1].replace('Z', '');
            const line = `[${ts}] ${message}${data ? " | " + JSON.stringify(data) : ""}`;
            logBuffer.push(line);
            if (logBuffer.length > LOG_MAX) logBuffer.shift();
            logLines.textContent = logBuffer.join("\n");
            logLines.scrollTop = logLines.scrollHeight;
            console.log(line);
        }
        window.logEvent = logEvent;

        window.addEventListener('error', (e) => {
            logEvent("window.error", { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno });
        });
        window.addEventListener('unhandledrejection', (e) => {
            logEvent("unhandledrejection", { reason: e.reason && (e.reason.message || e.reason) });
        });

        audioPlayer.addEventListener('play', () => logEvent("audio.play"));
        audioPlayer.addEventListener('pause', () => logEvent("audio.pause"));
        audioPlayer.addEventListener('ended', () => logEvent("audio.ended"));
        audioPlayer.addEventListener('error', () => logEvent("audio.error", { code: audioPlayer.error && audioPlayer.error.code }));

        // Show error if 'key' param is missing
        (function checkKeyParam() {
            if (!params.has('key')) {
                errorMessage.textContent = "Error: Missing 'key' parameter in URL. Please provide ?key=YOUR_KEY.";
                errorMessage.style.display = 'block';
            }
        })();

        // Function to change state and update status icon
        function setListeningState() {
            resetMicIcon();
            statusIcon.src = 'resources/mic.png';
            statusIcon.alt = 'Listening';
            statusIcon.classList.remove('mic-disabled');
            showStatusMessage();

        }
        function setActiveListeningState() {
            statusIcon.src = 'resources/mic.png';
            statusIcon.alt = 'Active Listening';
            statusIcon.classList.remove('mic-disabled');
            statusIcon.classList.remove('mic-no-transition');
            statusIcon.classList.add('mic-enlarged');
            showStatusMessage("???");
        }

        function setMuteState() {
            statusIcon.src = 'resources/mute.png';
            statusIcon.alt = 'Not Listening';
            statusIcon.classList.remove('mic-disabled');
            resetMicIcon();
            showStatusMessage();
            // Hide the power off button
            const offBtn = document.getElementById('off-btn');
            if (offBtn) offBtn.style.display = 'none';
        }
        // Function to change state and update status icon
        function setCommandState() {
            resetMicIcon();
            statusIcon.src = 'resources/check.png';
            statusIcon.alt = 'Command';
            statusIcon.classList.remove('mic-disabled');
        }

        function playAudio(audioUrl, speed = 1.0) {
            audioPlayer.src = audioUrl;
            audioPlayer.playbackRate = speed;
            audioPlayer.play().catch((err) => {
                console.warn("Audio playback blocked:", err);
                showAudioUnlockBanner();
            });
        };

        // Function to show/hide a message below the status icon
        function showStatusMessage(msg) {
            if (msg && msg.length > 0) {
                statusMessage.textContent = msg;
                statusMessage.style.visibility = 'visible';
            } else {
                statusMessage.textContent = '';
                statusMessage.style.visibility = 'hidden';
            }
        }

        function showErrorMessage(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
            setMuteState();
        }

        function showAudioUnlockBanner() {
            if (audioUnlockBanner) audioUnlockBanner.style.display = 'block';
        }

        function hideAudioUnlockBanner() {
            if (audioUnlockBanner) audioUnlockBanner.style.display = 'none';
        }


        // Reset mic icon to original size, no transition/pulse
        function resetMicIcon() {
            statusIcon.classList.remove('mic-enlarged');
            statusIcon.classList.add('mic-no-transition');
            // Force reflow to apply immediate reset
            void statusIcon.offsetWidth;
            statusIcon.classList.remove('mic-no-transition');
        }

        if (!params.has('key')) {
            showErrorMessage("'key' parameter in URL. Please provide ?key=YOUR_KEY.");
        } else {
            document.getElementById('off-btn').addEventListener('click', stopSession);
            window.addEventListener('beforeunload', stopSession);

            const unlockAudio = async () => {
                if (audioUnlocked) return true;
                if (audioUnlockInFlight) return audioUnlockInFlight;

                audioUnlockInFlight = (async () => {
                    logEvent("audio.unlock_attempt");
                    try {
                        // Attempt audio unlock; this is strongest in a user gesture.
                        init_beep();
                        if (audioCtx && audioCtx.state === 'suspended') {
                            await audioCtx.resume();
                        }
                        audioPlayer.muted = true;
                        audioPlayer.src = 'resources/ok.wav';
                        await audioPlayer.play();
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        audioPlayer.muted = false;
                        audioUnlocked = true;
                        logEvent("audio.unlocked");
                        hideAudioUnlockBanner();
                        return true;
                    } catch (e) {
                        logEvent("audio.unlock_failed", { message: e.message || String(e) });
                        showAudioUnlockBanner();
                        return false;
                    } finally {
                        audioUnlockInFlight = null;
                    }
                })();

                return audioUnlockInFlight;
            };

            const startApp = async () => {
                logEvent("startApp.begin");
                // Do not block mic/session startup on autoplay unlock behavior.
                unlockAudio().catch((e) => {
                    logEvent("audio.unlock_background_error", { message: e && (e.message || String(e)) });
                });
                try {
                    logEvent("session.starting");
                    await startSession();
                    logEvent("session.started");
                } catch (e) {
                    logEvent("session.start_failed", { message: e.message || String(e) });
                    showErrorMessage(`Failed to start session: ${e.message || e}`);
                }
            };

            // Start as early as possible on page load.
            startApp();

            // Fallback unlock for browsers that require a gesture for audio output.
            const unlockOnGesture = async () => {
                await unlockAudio();
                document.removeEventListener('pointerdown', unlockOnGesture);
                document.removeEventListener('keydown', unlockOnGesture);
                document.removeEventListener('touchstart', unlockOnGesture);
            };
            document.addEventListener('pointerdown', unlockOnGesture, { once: true });
            document.addEventListener('keydown', unlockOnGesture, { once: true });
            document.addEventListener('touchstart', unlockOnGesture, { once: true });
        }
        </script>
</body>

</html>
